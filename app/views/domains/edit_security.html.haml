- if @server
  - page_title << @server.name
- page_title << @domain.name
- page_title << "Email Security"

- if @server
  = render 'servers/sidebar', :active_server => @server
  = render 'servers/header', :active_nav => :domains
  = render 'nav', :active_nav => :domains
- else
  .pageHeader
    %h1.pageHeader__title
      %span.pageHeader__titlePrevious
        = @organization.name
        &rarr; Domains &rarr;
      = @domain.name
  = render 'organizations/nav', :active_nav => :domains

.pageContent.pageContent--compact
  %h2.pageContent__title Email Security Settings for #{@domain.name}
  %p.pageContent__intro.u-margin
    Configure MTA-STS and TLS-RPT to improve email security and get reports on TLS connection issues.

  = form_for @domain, :url => [:update_security, organization, @server, @domain], :remote => true do |f|
    = f.error_messages
    %fieldset.fieldSet
      %legend.fieldSet__legend MTA-STS (SMTP MTA Strict Transport Security)
      %p.pageContent__text.u-margin
        MTA-STS ensures that email servers use TLS when sending email to your domain, preventing downgrade attacks.
        %a{href: "https://datatracker.ietf.org/doc/html/rfc8461", target: "_blank"} Learn more about MTA-STS

      .fieldSet__field
        = f.label :mta_sts_enabled, "Enable MTA-STS", :class => 'fieldSet__label'
        .fieldSet__input
          = f.check_box :mta_sts_enabled, :class => 'input input--checkbox'
          %p.fieldSet__text After enabling, you'll need to configure DNS records (see DNS Setup page)

      .fieldSet__field
        = f.label :mta_sts_mode, "Policy Mode", :class => 'fieldSet__label'
        .fieldSet__input
          = f.select :mta_sts_mode, Domain::MTA_STS_MODES.map { |mode| [mode.titleize, mode] }, {}, :class => 'input input--select'
          %p.fieldSet__text
            %strong Testing:
            Receive reports but don't enforce TLS.
            %strong Enforce:
            Reject messages not sent over TLS.
            %strong None:
            Disable MTA-STS.

      .fieldSet__field
        = f.label :mta_sts_max_age, "Max Age (seconds)", :class => 'fieldSet__label'
        .fieldSet__input
          = f.number_field :mta_sts_max_age, :class => 'input input--text', :min => 86400, :step => 1
          %p.fieldSet__text How long should senders cache the policy (minimum 86400 = 1 day). Recommended: 604800 (7 days)

      .fieldSet__field
        = f.label :mta_sts_mx_patterns, "MX Patterns (one per line)", :class => 'fieldSet__label'
        .fieldSet__input
          = f.text_area :mta_sts_mx_patterns, :class => 'input input--textarea', :rows => 5, :placeholder => "*.mx.example.com\nmx1.example.com"
          %p.fieldSet__text
            Leave empty to use default MX records from your Postal configuration.
            Use wildcards (e.g., *.mx.example.com) to match multiple hosts.

    %fieldset.fieldSet
      %legend.fieldSet__legend TLS-RPT (TLS Reporting)
      %p.pageContent__text.u-margin
        TLS-RPT allows you to receive reports about TLS connection failures from sending mail servers.
        %a{href: "https://datatracker.ietf.org/doc/html/rfc8460", target: "_blank"} Learn more about TLS-RPT

      .fieldSet__field
        = f.label :tls_rpt_enabled, "Enable TLS-RPT", :class => 'fieldSet__label'
        .fieldSet__input
          = f.check_box :tls_rpt_enabled, :class => 'input input--checkbox'
          %p.fieldSet__text Receive aggregate reports about TLS connection issues

      .fieldSet__field
        = f.label :tls_rpt_email, "Report Email Address", :class => 'fieldSet__label'
        .fieldSet__input
          = f.text_field :tls_rpt_email, :class => 'input input--text', :placeholder => "tls-reports@#{@domain.name}"
          %p.fieldSet__text Where to send TLS reports. Leave empty to use tls-reports@#{@domain.name}

    .fieldSetSubmit.buttonSet
      = f.submit "Save Security Settings", :class => 'button button--positive js-form-submit'
      .fieldSetSubmit__delete
        = link_to "Back to DNS Setup", [:setup, organization, @server, @domain], :class => 'button button--neutral'

