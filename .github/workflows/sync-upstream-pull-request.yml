name: 'Sync Upstream Pull Requests'
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
permissions:
  issues: write
  pull-requests: write
jobs:
  sync-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/postalserver/postal.git
          git fetch upstream

      - name: Sync upstream PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM_OWNER: "postalserver"
          UPSTREAM_REPO: "postal"
        run: |
          # Ottieni le PR aperte dall'upstream
          upstream_prs=$(gh pr list --repo "$UPSTREAM_OWNER/$UPSTREAM_REPO" --state open --json number,title,headRefName,baseRefName,body,author)
          
          # Ottieni le PR esistenti nel fork
          fork_prs=$(gh pr list --json title,headRefName)
          
          echo "$upstream_prs" | jq -c '.[]' | while read -r pr; do
            pr_number=$(echo "$pr" | jq -r '.number')
            pr_title=$(echo "$pr" | jq -r '.title')
            pr_head=$(echo "$pr" | jq -r '.headRefName')
            pr_base=$(echo "$pr" | jq -r '.baseRefName')
            pr_body=$(echo "$pr" | jq -r '.body')
            pr_author=$(echo "$pr" | jq -r '.author.login')
          
            # Escludi PR che iniziano con "chore"
            if [[ "$pr_title" =~ ^[Cc]hore ]]; then
              echo "Saltando PR #$pr_number (chore): $pr_title"
              continue
            fi
          
            # Crea un nome branch unico per il fork
            fork_branch="upstream-pr-$pr_number"
          
            # Controlla se questa PR è già stata sincronizzata
            if echo "$fork_prs" | jq -e --arg branch "$fork_branch" '.[] | select(.headRefName == $branch)' > /dev/null; then
              echo "PR #$pr_number già sincronizzata"
              continue
            fi
          
            echo "Sincronizzando PR #$pr_number: $pr_title"
          
            # Fetch del branch dall'upstream
            git fetch upstream "$pr_head:$fork_branch" || {
              echo "Impossibile fare fetch del branch $pr_head"
              continue
            }
          
            # Push del branch al fork
            git push origin "$fork_branch"
          
            # Crea la PR nel fork
            gh pr create \
              --title "[Upstream PR #$pr_number] $pr_title" \
              --body "**Sincronizzata dalla PR upstream:** https://github.com/$UPSTREAM_OWNER/$UPSTREAM_REPO/pull/$pr_number\n**Autore originale:** @$pr_author\n\n\n---\n\n$pr_body" \
              --head "$fork_branch" \
              --base "$pr_base" || echo "Errore nella creazione della PR per #$pr_number"
            done
